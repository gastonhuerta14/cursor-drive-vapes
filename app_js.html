<script>
const $ = s => document.querySelector(s);
let currentSeller = '', currentCat = '', currentProd = '';

function gs(fn, payload){
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(resolve)
      .withFailureHandler(err => reject(err?.message || String(err)))
      [fn](payload || {});
  });
}

function setStep(n){
  $('#step-indicator').textContent = `${n}/3`;
  $('#step-1').classList.toggle('hidden', n !== 1);
  $('#step-2').classList.toggle('hidden', n !== 2);
  $('#step-3').classList.toggle('hidden', n !== 3);
}

async function loadSellers(){
  const wrap = $('#grid-sellers');
  const manualWrap = $('#seller-manual-wrap');
  wrap.innerHTML = '';
  manualWrap.classList.add('hidden');

  const renderTiles = (names = []) => {
    if (!Array.isArray(names) || names.length === 0) {
      manualWrap.classList.remove('hidden');
      return;
    }
    wrap.innerHTML = names.map(name => `
      <button class="tile-btn" data-seller="${(name || '').replace(/"/g, '&quot;')}">${name}</button>
    `).join('');
    wrap.querySelectorAll('.tile-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        currentSeller = btn.dataset.seller;
        nextFromSeller();
      });
    });
  };

  try {
    const sellers = await gs('listSellers');
    renderTiles(sellers);
  } catch (error) {
    console.error('listSellers error:', error);
    manualWrap.classList.remove('hidden');
  }
}

function nextFromSeller(){
  setStep(2);
  loadCategories();
}

function placeholderFor(cat){
  const key = (cat || '').toLowerCase();
  if (key.includes('kit')) return 'https://picsum.photos/seed/kit/640/360';
  if (key.includes('cart')) return 'https://picsum.photos/seed/cart/640/360';
  if (key.includes('sk')) return 'https://picsum.photos/seed/sk/640/360';
  return 'https://picsum.photos/seed/vapes/640/360';
}

async function loadCategories(){
  const grid = $('#grid-cats');
  grid.innerHTML = '';
  try {
    const cats = await gs('listCategoriesWithImages');
    if (!cats || !cats.length) {
      grid.innerHTML = '<div class="hint">No hay stock disponible.</div>';
      return;
    }
    grid.innerHTML = cats.map(item => `
      <div class="card" data-cat="${item.categoria}">
        <img src="${item.img || placeholderFor(item.categoria)}" alt="">
        <div class="label">${item.categoria}</div>
      </div>`).join('');
    grid.querySelectorAll('.card').forEach(card => {
      card.addEventListener('click', () => openCategory(card.dataset.cat));
    });
  } catch (error) {
    console.error('listCategoriesWithImages error:', error);
    grid.innerHTML = '<div class="hint">No se pudieron cargar las categorías.</div>';
  }
}

async function openCategory(cat){
  currentCat = cat;
  setStep(3);
  $('#title-cat').textContent = cat;
  const grid = $('#grid-products');
  grid.innerHTML = '';
  try {
    const products = await gs('listProductsByCategory', { categoria: cat });
    if (!products || !products.length) {
      grid.innerHTML = '<div class="hint">Sin productos disponibles.</div>';
      return;
    }
    grid.innerHTML = products.map(product => `
      <div class="card" data-prod="${product.producto}">
        <img src="${placeholderFor(cat)}" alt="">
        <div class="label">${product.producto}</div>
      </div>`).join('');
    grid.querySelectorAll('.card').forEach(card => {
      card.addEventListener('click', () => openSheet(card.dataset.prod));
    });
  } catch (error) {
    console.error('listProductsByCategory error:', error);
    grid.innerHTML = '<div class="hint">No se pudieron cargar los productos.</div>';
  }
}

async function openSheet(prod){
  currentProd = prod;
  try {
    const info = await gs('getProductInfo', { producto: prod });
    $('#p-name').textContent = prod;
    $('#p-price').textContent = new Intl.NumberFormat('es-AR').format(info.precio);
    $('#p-stock').textContent = info.cantidad;
    $('#p-qty').value = 1;
    $('#p-msg').textContent = '';
    $('#sheet').classList.remove('hidden');
  } catch (error) {
    console.error('getProductInfo error:', error);
    alert('No se pudo cargar la información del producto.');
  }
}

async function doSell(){
  const vendedor = currentSeller || ($('#seller-manual')?.value || '').trim();
  const qty = Number($('#p-qty').value || 1);
  const msg = $('#p-msg');
  msg.style.color = '#9aa3b2';
  msg.textContent = 'Procesando…';
  try {
    const result = await gs('sell', { vendedor, producto: currentProd, cantidadVendida: qty });
    if (!result.ok) {
      msg.style.color = '#ff8b8b';
      msg.textContent = result.error || 'Error';
      return;
    }
    msg.style.color = '#6ee7b7';
    msg.textContent = `Venta OK. Pedido: ${result.pedidoId} | Stock: ${result.nuevoStock}`;
    $('#p-stock').textContent = result.nuevoStock;
  } catch (error) {
    msg.style.color = '#ff8b8b';
    msg.textContent = String(error);
  }
}

function closeSheet(){
  $('#sheet').classList.add('hidden');
}

document.addEventListener('DOMContentLoaded', async () => {
  setStep(1);
  $('#sheet').classList.add('hidden');
  const manualButton = document.getElementById('seller-manual-continue');
  if (manualButton) {
    manualButton.addEventListener('click', () => {
      const input = document.getElementById('seller-manual');
      const value = (input?.value || '').trim();
      if (!value) {
        input?.focus();
        return;
      }
      currentSeller = value;
      nextFromSeller();
    });
  }
  await loadSellers();
  document.getElementById('back-1').addEventListener('click', () => setStep(1));
  document.getElementById('back-2').addEventListener('click', () => setStep(2));
  document.getElementById('p-sell').addEventListener('click', doSell);
  document.getElementById('p-close').addEventListener('click', closeSheet);
});
</script>
